name: Add New App (Seed Generator)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: '앱 ID (예: Orbmu2k.nvidiaProfileInspector)'
        required: true
      repo_url:
        description: '깃허브 주소 (예: https://github.com/Orbmu2k/nvidiaProfileInspector)'
        required: true
      version_prefix:
        description: '버전 앞글자 (보통 v, 없으면 비우기)'
        required: false
        default: 'v'

permissions:
  contents: write

jobs:
  create-seed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Seed Manifest
        run: |
          # 1. 입력값 변수에 담기
          ID="${{ inputs.package_id }}"
          URL="${{ inputs.repo_url }}"
          PREFIX="${{ inputs.version_prefix }}"
          
          # 2. ID에서 이름과 제조사 자동 추출 (점. 기준으로 자름)
          PUBLISHER=$(echo $ID | cut -d. -f1)
          NAME=$(echo $ID | cut -d. -f2)

          # 3. 저장할 폴더 만들기
          mkdir -p manifests

          # 4. 씨앗 파일(YAML) 자동 생성
          # (버전은 0.0.0.0 가짜로 넣어서 나중에 업데이트 봇이 일하게 만듦)
          cat <<EOF > manifests/$ID.yaml
          PackageIdentifier: $ID
          PackageVersion: 0.0.0.0
          PackageName: $NAME
          Publisher: $PUBLISHER
          Moniker: $NAME
          PackageUrl: $URL
          ShortDescription: Auto-generated manifest for $NAME
          Installers:
            - Architecture: x64
              InstallerUrl: $URL/releases/download/${PREFIX}0.0.0/placeholder.zip
              InstallerType: zip
          ManifestType: singleton
          ManifestVersion: 1.0.0
          EOF

          echo "✅ Created manifest for $ID"

      - name: Commit & Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add manifests/*.yaml
          git commit -m "Add new app: ${{ inputs.package_id }}" || echo "No changes to commit"
          git push
