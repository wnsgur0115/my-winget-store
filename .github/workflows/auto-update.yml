name: auto update manifests

on:
  schedule:
    - cron: '23 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  parse-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: install yq
        run: |
          set -euo pipefail
          YQ_VER="v4.45.1"
          curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VER}/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version
          jq --version

      - id: parse
        run: |
          set -euo pipefail
          if [ ! -f packages.yml ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          matrix="$(yq -o=json '.packages' packages.yml | jq -c '.')"

          {
            echo "matrix<<EOF"
            echo "$matrix"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  update:
    needs: parse-packages
    if: needs.parse-packages.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.parse-packages.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - id: resolve
        name: resolve latest release + asset url
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          repo="${{ matrix.package.repo }}"
          regex="${{ matrix.package.asset_regex }}"

          latest="$(gh api "repos/${repo}/releases/latest")"
          tag="$(echo "$latest" | jq -r .tag_name)"
          ver="${tag#v}"

          asset_url="$(echo "$latest" | jq -r --arg regex "$regex" \
            '.assets[] | select(.name | test($regex)) | .browser_download_url' | head -1)"

          if [ -z "$asset_url" ]; then
            echo "skip=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ver=$ver" >> "$GITHUB_OUTPUT"
          echo "asset_url=$asset_url" >> "$GITHUB_OUTPUT"
          echo "skip=0" >> "$GITHUB_OUTPUT"

      - name: update local manifests (url/version/sha256)
        if: steps.resolve.outputs.skip != '1'
        run: |
          set -euo pipefail

          id="${{ matrix.package.id }}"
          ver="${{ steps.resolve.outputs.ver }}"
          url="${{ steps.resolve.outputs.asset_url }}"
          dir="manifests/${id}"

          if [ ! -d "$dir" ]; then
            echo "manifest dir not found: $dir (skip)"
            exit 0
          fi

          mkdir -p .tmp
          file=".tmp/installer"
          curl -fsSL "$url" -o "$file"
          sha="$(sha256sum "$file" | awk '{print $1}')"

          echo "updating $id -> $ver"
          echo "url=$url"
          echo "sha=$sha"

          # manifests/<id> 아래 yaml 전부에서 보이는 필드만 갱신
          shopt -s globstar nullglob
          for f in "$dir"/**/*.yml "$dir"/**/*.yaml; do
            # PackageVersion
            yq -i ".PackageVersion = \"$ver\" | .PackageVersion style=\"\"" "$f" 2>/dev/null || true

            # Installers[].InstallerUrl / InstallerSha256
            yq -i '
              (.Installers[]? | select(has("InstallerUrl")) | .InstallerUrl) = strenv(URL) |
              (.Installers[]? | select(has("InstallerSha256")) | .InstallerSha256) = strenv(SHA)
            ' "$f" 2>/dev/null || true
          done

        env:
          URL: ${{ steps.resolve.outputs.asset_url }}
          SHA: ${{ steps.resolve.outputs.sha }}

      - name: commit & push (if changed)
        if: steps.resolve.outputs.skip != '1'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add manifests/ || true
          if git diff --staged --quiet; then
            echo "no changes"
            exit 0
          fi

          git commit -m "chore: update ${{ matrix.package.id }} -> ${{ steps.resolve.outputs.ver }}"
          git push
