name: Update Manifests (Komac)

on:
  schedule:
    - cron: '17 * * * *' 
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write

jobs:
  update-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.KOMAC_TOKEN }} # ì“°ê¸° ê¶Œí•œ í™•ë³´

      # 1. Komac ë„êµ¬ ì„¤ì¹˜
      - uses: michidk/run-komac@v2
      
      # 2. [í•µì‹¬] í´ë”ì— ìˆëŠ” ëª¨ë“  ì•±ì„ ì°¾ì•„ì„œ í•˜ë‚˜ì”© ì—…ë°ì´íŠ¸ ì‹¤í–‰
      - name: Scan and Update All Apps
        env:
          GITHUB_TOKEN: ${{ secrets.KOMAC_TOKEN }}
          KOMAC_TOKEN: ${{ secrets.KOMAC_TOKEN }}
        run: |
          # manifests í´ë”ê°€ ì—†ìœ¼ë©´ ë„˜ì–´ê°€ê¸°
          if [ ! -d "manifests" ]; then
            echo "âŒ manifests í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•±ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”."
            exit 0
          fi

          # í´ë” ì•ˆì˜ ëª¨ë“  yaml íŒŒì¼(*.yaml)ì„ ì°¾ì•„ì„œ ë°˜ë³µ
          for file in manifests/*.yaml; do
            # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ (ì˜¤ë¥˜ ë°©ì§€)
            [ -e "$file" ] || continue

            # íŒŒì¼ëª…ì—ì„œ ID ì¶”ì¶œ (ì˜ˆ: manifests/abc.def.yaml -> abc.def)
            id=$(basename "$file" .yaml)
            echo "---------------------------------------------------"
            echo "ğŸš€ ê²€ìƒ‰ ì¤‘: $id"

            # Komac ì‹¤í–‰ (ê° ì•±ë§ˆë‹¤ ë”°ë¡œ ëª…ë ¹)
            # --verbose: ìì„¸í•œ ë¡œê·¸ ì¶œë ¥ (ì˜¤ë¥˜ í™•ì¸ìš©)
            komac update $id \
              --token ${{ secrets.KOMAC_TOKEN }} \
              --submit-pr false \
              --commit-direct true \
              --verbose || echo "âš ï¸ $id ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ (ì´ë¯¸ ìµœì‹ ì´ê±°ë‚˜ ì˜¤ë¥˜)"
              
          done
          echo "---------------------------------------------------"
          echo "âœ¨ ëª¨ë“  ì‘ì—… ì™„ë£Œ"
